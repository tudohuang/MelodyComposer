<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melody Examples - Buzzer Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #1e1e2f 0%, #2d2d44 100%);
            color: #ffffff;
            font-family: 'Arial', sans-serif;
            padding: 20px;
            user-select: none;
        }
        .container { max-width: 1200px; }
        h1 { font-size: 2.5rem; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); }
        .example-list {
            background: #2a2a3f;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }
        .example-item {
            padding: 15px;
            border-bottom: 1px solid #3a3a5e;
            cursor: pointer;
        }
        .example-item:hover {
            background: #3a3a5e;
        }
        .example-item:last-child {
            border-bottom: none;
        }
        .example-detail {
            display: none;
            background: #1a1a2e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            margin-top: 20px;
        }
        .example-detail.active {
            display: block;
        }
        .code-block {
            background: #0f0f1a;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            color: #00ff9d;
            white-space: pre-wrap;
            margin-bottom: 10px;
        }
        #melody-preview {
            width: 100%;
            height: 150px;
            background: #1a1a2e;
            border-radius: 10px;
            margin-top: 20px;
            overflow-x: auto;
        }
        .btn-custom {
            padding: 8px 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .note-item {
            display: flex;
            align-items: center;
            padding: 5px;
            background: #3a3a5e;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        .note-item span { flex: 1; color: #d0d0ff; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Melody Examples</h1>
        <div class="example-list">
            <h5>Select an Example:</h5>
            <div class="example-item" onclick="showExample('twinkle')">Twinkle Twinkle</div>
            <div class="example-item" onclick="showExample('happyBirthday')">Happy Birthday</div>
            <div class="example-item" onclick="showExample('maryHadALittleLamb')">Mary Had a Little Lamb</div>
            <div class="example-item" onclick="showExample('jingleBells')">Jingle Bells</div>
            <div class="example-item" onclick="showExample('odeToJoy')">Ode to Joy</div>
            <div class="example-item" onclick="showExample('superMario')">Super Mario Bros. Theme</div>
            <div class="example-item" onclick="showExample('starWars')">Star Wars Theme</div>
            <div class="example-item" onclick="showExample('piratesCaribbean')">Pirates of the Caribbean</div>
            <div class="example-item" onclick="showExample('totoro')">Totoro Theme</div>
        </div>
        <div class="example-detail" id="exampleDetail">
            <h5 id="exampleTitle"></h5>
            <div class="code-block" id="exampleCode"></div>
            <h6>Editable Notes:</h6>
            <div id="editableNotes"></div>
            <canvas id="melody-preview"></canvas>
            <div class="text-center mt-3">
                <button class="btn btn-primary btn-custom me-2" onclick="playCurrentExample()">Play</button>
                <button class="btn btn-success btn-custom me-2" onclick="saveEditedExample()">Save to Main</button>
                <button class="btn btn-secondary btn-custom" onclick="window.location.href='index.html'">Back to Main</button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const NOTE_FREQS = {
            'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81,
            'F3': 174.61, 'F#3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'A3': 220.00,
            'A#3': 233.08, 'B3': 246.94, 'C4': 261.63, 'C#4': 277.18,'E4': 277.18, 'D4': 293.66,
            'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00,
            'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88, 'C5': 523.25,
            'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25, 'F5': 698.46,
            'F#5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'A5': 880.00, 'A#5': 932.33,
            'B5': 987.77, 'C6': 1046.50, 'C#6': 1108.73, 'D6': 1174.66, 'D#6': 1244.51,
            'E6': 1318.51, 'F6': 1396.91, 'F#6': 1479.98
        };

        const keys = [
            { note: 'C3', type: 'white' }, { note: 'C#3', type: 'black' },
            { note: 'D3', type: 'white' }, { note: 'D#3', type: 'black' },
            { note: 'E3', type: 'white' }, { note: 'F3', type: 'white' },
            { note: 'F#3', type: 'black' }, { note: 'G3', type: 'white' },
            { note: 'G#3', type: 'black' }, { note: 'A3', type: 'white' },
            { note: 'A#3', type: 'black' }, { note: 'B3', type: 'white' },
            { note: 'C4', type: 'white' }, { note: 'C#4', type: 'black' },
            { note: 'D4', type: 'white' }, { note: 'D#4', type: 'black' },
            { note: 'E4', type: 'white' }, { note: 'F4', type: 'white' },
            { note: 'F#4', type: 'black' }, { note: 'G4', type: 'white' },
            { note: 'G#4', type: 'black' }, { note: 'A4', type: 'white' },
            { note: 'A#4', type: 'black' }, { note: 'B4', type: 'white' },
            { note: 'C5', type: 'white' }, { note: 'C#5', type: 'black' },
            { note: 'D5', type: 'white' }, { note: 'D#5', type: 'black' },
            { note: 'E5', type: 'white' }, { note: 'F5', type: 'white' },
            { note: 'F#5', type: 'black' }, { note: 'G5', type: 'white' },
            { note: 'G#5', type: 'black' }, { note: 'A5', type: 'white' },
            { note: 'A#5', type: 'black' }, { note: 'B5', type: 'white' },
            { note: 'C6', type: 'white' }, { note: 'C#6', type: 'black' },
            { note: 'D6', type: 'white' }, { note: 'D#6', type: 'black' },
            { note: 'E6', type: 'white' }, { note: 'F6', type: 'white' },
            { note: 'F#6', type: 'black' }
        ];

        const presets = {
            'twinkle': [
                { note: 'C4', type: 'quarter', isRest: false },
                { note: 'C4', type: 'quarter', isRest: false },
                { note: 'G4', type: 'quarter', isRest: false },
                { note: 'G4', type: 'quarter', isRest: false },
                { note: 'A4', type: 'quarter', isRest: false },
                { note: 'A4', type: 'quarter', isRest: false },
                { note: 'G4', type: 'half', isRest: false }
            ],
            'happyBirthday': [
                { note: 'C4', type: 'quarter', isRest: false },
                { note: 'C4', type: 'eighth', isRest: false },
                { note: 'D4', type: 'quarter', isRest: false },
                { note: 'C4', type: 'quarter', isRest: false },
                { note: 'F4', type: 'quarter', isRest: false },
                { note: 'E4', type: 'half', isRest: false },
                { note: 'C4', type: 'quarter', isRest: false },
                { note: 'C4', type: 'eighth', isRest: false },
                { note: 'D4', type: 'quarter', isRest: false },
                { note: 'C4', type: 'quarter', isRest: false },
                { note: 'G4', type: 'quarter', isRest: false },
                { note: 'F4', type: 'half', isRest: false }
            ],
            'maryHadALittleLamb': [
                { note: 'E4', type: 'quarter', isRest: false },
                { note: 'D4', type: 'quarter', isRest: false },
                { note: 'C4', type: 'quarter', isRest: false },
                { note: 'D4', type: 'quarter', isRest: false },
                { note: 'E4', type: 'quarter', isRest: false },
                { note: 'E4', type: 'quarter', isRest: false },
                { note: 'E4', type: 'half', isRest: false }
            ],
            'jingleBells': [
                { note: 'E4', type: 'eighth', isRest: false },
                { note: 'E4', type: 'eighth', isRest: false },
                { note: 'E4', type: 'quarter', isRest: false },
                { note: 'E4', type: 'eighth', isRest: false },
                { note: 'E4', type: 'eighth', isRest: false },
                { note: 'E4', type: 'quarter', isRest: false },
                { note: 'E4', type: 'eighth', isRest: false },
                { note: 'G4', type: 'eighth', isRest: false }
            ],
            'odeToJoy': [
                { note: 'E4', type: 'quarter', isRest: false },
                { note: 'E4', type: 'quarter', isRest: false },
                { note: 'F4', type: 'quarter', isRest: false },
                { note: 'G4', type: 'quarter', isRest: false },
                { note: 'G4', type: 'quarter', isRest: false },
                { note: 'F4', type: 'quarter', isRest: false },
                { note: 'E4', type: 'quarter', isRest: false },
                { note: 'D4', type: 'half', isRest: false }
            ],
            'superMario': [
                { note: 'E4', type: 'eighth', isRest: false },
                { note: 'E4', type: 'eighth', isRest: false },
                { note: 'Rest', type: 'eighth', isRest: true },
                { note: 'E4', type: 'eighth', isRest: false },
                { note: 'Rest', type: 'eighth', isRest: true },
                { note: 'C4', type: 'eighth', isRest: false },
                { note: 'E4', type: 'quarter', isRest: false },
                { note: 'G4', type: 'quarter', isRest: false },
                { note: 'Rest', type: 'quarter', isRest: true }
            ],
            'starWars': [
                { note: 'G4', type: 'quarter', isRest: false },
                { note: 'G4', type: 'quarter', isRest: false },
                { note: 'G4', type: 'quarter', isRest: false },
                { note: 'D4', type: 'eighth', isRest: false },
                { note: 'C5', type: 'half', isRest: false },
                { note: 'B4', type: 'quarter', isRest: false },
                { note: 'A4', type: 'quarter', isRest: false },
                { note: 'G4', type: 'half', isRest: false }
            ],
            'piratesCaribbean': [
                { note: 'D4', type: 'eighth', isRest: false },
                { note: 'D4', type: 'eighth', isRest: false },
                { note: 'D4', type: 'eighth', isRest: false },
                { note: 'E4', type: 'eighth', isRest: false },
                { note: 'F4', type: 'eighth', isRest: false },
                { note: 'F4', type: 'eighth', isRest: false },
                { note: 'E4', type: 'eighth', isRest: false },
                { note: 'F4', type: 'eighth', isRest: false },
                { note: 'G4', type: 'quarter', isRest: false }
            ],
            'totoro': [
                { note: 'F4', type: 'quarter', isRest: false },
                { note: 'G4', type: 'quarter', isRest: false },
                { note: 'A4', type: 'quarter', isRest: false },
                { note: 'G4', type: 'quarter', isRest: false },
                { note: 'F4', type: 'quarter', isRest: false },
                { note: 'E4', type: 'quarter', isRest: false },
                { note: 'D4', type: 'quarter', isRest: false },
                { note: 'E4', type: 'half', isRest: false }
            ]
        };

        let currentExample = [];

        function showExample(exampleName) {
            currentExample = [...presets[exampleName]]; // 創建副本
            const detail = document.getElementById('exampleDetail');
            const title = document.getElementById('exampleTitle');
            const code = document.getElementById('exampleCode');
            const editableNotes = document.getElementById('editableNotes');

            title.textContent = `${exampleName.replace(/([A-Z])/g, ' $1').trim()} Example`;
            code.textContent = JSON.stringify(currentExample, null, 2);

            editableNotes.innerHTML = '';
            currentExample.forEach((item, index) => {
                const duration = Math.round(getDuration(item.type));
                const div = document.createElement('div');
                div.className = 'note-item';
                div.innerHTML = `
                    <select onchange="updateNote(${index}, 'note', this.value)">
                        <option value="Rest" ${item.note === 'Rest' ? 'selected' : ''}>Rest</option>
                        ${Object.keys(NOTE_FREQS).map(note => `<option value="${note}" ${item.note === note ? 'selected' : ''}>${note}</option>`).join('')}
                    </select>
                    <div class="btn-group ms-2">
                        <button class="btn btn-sm btn-outline-light" onclick="updateNote(${index}, 'type', '32th')">1/32</button>
                        <button class="btn btn-sm btn-outline-light" onclick="updateNote(${index}, 'type', '16th')">1/16</button>
                        <button class="btn btn-sm btn-outline-light" onclick="updateNote(${index}, 'type', 'eighth')">1/8</button>
                        <button class="btn btn-sm btn-outline-light" onclick="updateNote(${index}, 'type', 'quarter')">1/4</button>
                        <button class="btn btn-sm btn-outline-light" onclick="updateNote(${index}, 'type', 'half')">1/2</button>
                        <button class="btn btn-sm btn-outline-light" onclick="updateNote(${index}, 'type', 'whole')">1/1</button>
                    </div>
                    <span>(${item.type}, ${duration}ms)</span>
                    <button class="btn btn-sm btn-danger ms-2" onclick="removeNoteFromExample(${index})">X</button>
                `;
                editableNotes.appendChild(div);
            });

            drawMelodyPreview();
            detail.classList.add('active');
        }

        function updateNote(index, field, value) {
            currentExample[index][field] = value;
            currentExample[index].isRest = (value === 'Rest');
            showExample(currentExample[0].note); // 重新渲染
        }

        function removeNoteFromExample(index) {
            currentExample.splice(index, 1);
            if (currentExample.length > 0) {
                showExample(currentExample[0].note); // 重新渲染
            } else {
                document.getElementById('exampleDetail').classList.remove('active');
            }
        }

        function getDuration(type) {
            const quarterDuration = 60000 / 120; // 固定 BPM 120 作為範例
            const durations = {
                'whole': quarterDuration * 4,
                'half': quarterDuration * 2,
                'quarter': quarterDuration,
                'eighth': quarterDuration / 2,
                '16th': quarterDuration / 4,
                '32th': quarterDuration / 8
            };
            return durations[type];
        }

        function playCurrentExample() {
            let delay = 0;
            currentExample.forEach(item => {
                const duration = getDuration(item.type);
                if (!item.isRest && NOTE_FREQS[item.note]) {
                    setTimeout(() => playTone(NOTE_FREQS[item.note], duration), delay);
                }
                delay += duration + 50;
            });
        }

        function playTone(freq, duration) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            oscillator.type = 'sine'; // 預設正弦波
            oscillator.frequency.value = freq || 440; // 預設 A4 如果無效
            oscillator.connect(audioContext.destination);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }

        function saveEditedExample() {
            const data = JSON.stringify(currentExample);
            localStorage.setItem('editedMelody', data); // 儲存到 localStorage
            window.location.href = 'index.html'; // 返回主頁
        }

        function drawMelodyPreview() {
            const canvas = document.getElementById('melody-preview');
            const ctx = canvas.getContext('2d');
            const width = canvas.scrollWidth;
            canvas.width = width;
            canvas.height = 150;

            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, width, 150);

            const totalDuration = currentExample.reduce((sum, item) => sum + getDuration(item.type) + 50, 0);
            const scaleX = totalDuration > 0 ? width / totalDuration : 1;
            let x = 0;

            currentExample.forEach(item => {
                const duration = getDuration(item.type);
                const w = duration * scaleX;

                if (item.isRest) {
                    ctx.strokeStyle = '#888888';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(x, 75);
                    ctx.lineTo(x + w, 75);
                    ctx.stroke();
                    ctx.setLineDash([]);
                } else {
                    const noteIndex = keys.findIndex(k => k.note === item.note);
                    const y = 140 - (noteIndex * 3);
                    ctx.fillStyle = '#00ff9d';
                    ctx.fillRect(x, y, w, 3);
                }
                x += (duration + 50) * scaleX;
            });
        }
    </script>
</body>
</html>
